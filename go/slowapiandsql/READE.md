## æ…¢SQLä¼˜åŒ–

--- 

## 1. å…ˆçœ‹çœ‹æ…¢sqlå’Œæ…¢SQLçš„èƒŒæ™¯

* èƒŒæ™¯ï¼š
  * è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶åŒæ­¥å¯¼å‡ºçš„æŽ¥å£ï¼Œå‰ç«¯å‘åŽç«¯å‘èµ·åˆ†é¡µè¯·æ±‚ï¼Œç„¶åŽåŽç«¯æ ¹æ®å‰ç«¯è¯·æ±‚è¿›è¡Œåˆ†é¡µæŸ¥è¯¢ï¼Œå¹¶å°†åˆ†é¡µæ•°æ®è¿”å›žç»™å‰ç«¯ï¼Œå‰ç«¯æœ€ç»ˆæ•´åˆæ•°æ®å°è£…æˆä¸€ä¸ªexcelæ–‡ä»¶è¿›è¡Œå¯¼å‡ºã€‚
  * ç„¶åŽSQLçš„æŸ¥è¯¢æ“ä½œå°±æ˜¯æ ¹æ®åˆ—è¡¨é¡µé¢çš„ç­›é€‰æ¡ä»¶ï¼Œç­›é€‰å‡ºç¬¦åˆæ¡ä»¶çš„ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œåˆ†é¡µè¿”å›žã€‚

* å†è¯´ä¸€ä¸‹æ•°æ®çš„ç›¸å…³ä¿¡æ¯ï¼š
    * father_tableè¡¨ï¼šæ•°æ®é‡**60w**
    * children_tableè¡¨ï¼šæ•°æ®é‡**110w**
    * **SQLæ‰§è¡Œæ—¶é—´ 2.4s**

æ€Žä¹ˆæ ·ï¼Œä¹ä¸€çœ‹è¿™ä¸ªæ•°æ®é‡æ˜Žæ˜Žä¸å¤§ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¿™ä¸ªSQLä¼šè¿™ä¹ˆæ…¢å‘¢ï¼Ÿï¼Ÿç»§ç»­å¾€ä¸‹çœ‹çœ‹ã€‚
```sql
SELECT `father_table`.`filed_1`,
       `father_table`.`order_code`,
       `father_table`.`filed_2`,
       `father_table`.`filed_3`,
       `father_table`.`filed_4`,
       `father_table`.`filed_5`,
       `father_table`.`filed_6`,
       `father_table`.`order_time`,
       `father_table`.`commodity_type`,
       `father_table`.`filed_7`,
       `father_table`.`filed_8`,
       `father_table`.`filed_10`,
       `father_table`.`filed_11`,
       `children_table`.`filed_12`,
       `children_table`.`filed_13`,
       `children_table`.`filed_14`,
       `children_table`.`filed_15`,
       `children_table`.`filed_16`,
       `children_table`.`filed_17`,
       `children_table`.`filed_18`,
       `children_table`.`filed_19`,
       `children_table`.`filed_20`,
       `children_table`.`id` AS `children_table_id`
FROM `children_table`
         INNER JOIN `father_table` ON `father_table`.`order_code` = `children_table`.`order_code`
WHERE `father_table`.`commodity_type` = '1'
  AND `father_table`.`filed_21` = '1'
  AND `father_table`.`order_time` >= '2023-06-01'
  AND `children_table`.`deleted_at` IS NULL
ORDER BY `children_table`.`created_at` DESC
LIMIT 100 OFFSET 111200

```

okï¼Œçœ‹åˆ°è¿™ä¸ªSQLåŽï¼Œä½ ä¼šæœ‰ä»€ä¹ˆæƒ³æ³•å‘¢ï¼ŸåŠ ç´¢å¼•ï¼Ÿwhereè¿‡æ»¤ï¼Ÿjoinçš„é—®é¢˜ï¼ŸæŽ’åºï¼Ÿ  
æ˜¯ä¸æ˜¯ä¸€æ—¶ä¸çŸ¥é“å¦‚ä½•ä¸‹æ‰‹ï¼Œæ²¡é”™å’Œæˆ‘ä¸€æ ·ï¼Œæˆ‘åœ¨è¿™å‘¨å¼€å§‹çš„æ—¶å€™ä¹Ÿæ˜¯è¿™æ ·çš„ã€‚ä½†æ˜¯æˆ‘ä»¬å…ˆä¸è¯´æ€Žä¹ˆè§£å†³ï¼Œæˆ‘ä»¬å¾—å¤ä¹ ä¸€ä¸‹åŸºç¡€çŸ¥è¯†ã€‚

è¿™é‡Œæˆ‘å…ˆå‘Šè¯‰ä½ ç­”æ¡ˆï¼šè¿™ä¸ªæ…¢sqlçš„é—®é¢˜æ˜¯**order by** + **æ·±åº¦åˆ†é¡µ**

è¿™é‡Œæˆ‘å°±ç½—åˆ—å‡ºæ¥ä¸€ä¸ªå¤§çº²ï¼Œä½†æ˜¯éœ€è¦ä½ åŽ»çœ‹çœ‹å…¶ä»–èµ„æ–™ï¼Œè¿™é‡Œæˆ‘åªåšjoinè¿žè¡¨çš„çŸ¥è¯†æ¢³ç†ã€‚ å˜¿å˜¿ðŸ˜,å…ˆé™„ä¸Šä¸€ä¸ª**SQLçš„æ‰§è¡Œé¡ºåº**   
![SQLçš„æ‰§è¡Œé¡ºåº](./img/sql_order.png)    


* ä¸‹é¢çš„ä½ å¾—å…ˆçœ‹çœ‹ðŸ‘‡

1. **mysqlçš„ç´¢å¼•ç±»åž‹ï¼Œä½¿ç”¨ç´¢å¼•çš„æ—¶å€™ï¼Œç´¢å¼•æ˜¯å¦‚ä½•å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½æ•°æ®çš„**
2. **mysqlçš„ç´¢å¼•ç±»åž‹ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦å›žè¡¨**
3. **explain æ€Žä¹ˆç”¨ï¼Œæ€Žä¹ˆçœ‹ï¼Œçœ‹ä»€ä¹ˆ** ï¼ˆæˆ‘ä¸‹é¢ä¹Ÿä¼šå†™ä¸€ç‚¹ï¼‰
4. **è”è¡¨çš„æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆ** ï¼ˆè¿™ä¸ªæˆ‘ä¸‹é¢ä¼šæ¥åˆ†äº«ï¼‰
5. MySQL ä¼˜åŒ–å™¨åšäº†ä»€ä¹ˆï¼ˆè¿™ä¸ªå¯ä»¥äº†è§£ï¼Œä¸ç”¨æ·±ç©¶ï¼Œä½†æ˜¯ä½ éœ€è¦çŸ¥é“ç´¢å¼•çš„é€‰æ‹©æ˜¯é€šè¿‡ä¼˜åŒ–å™¨å†³å®šçš„ï¼‰

--- 

## 2. æ¦‚å¿µæ¢³ç†

### è¡¨çš„é©±åŠ¨

* **é©±åŠ¨è¡¨**ï¼ˆDriving Tableï¼‰ï¼š
  é©±åŠ¨è¡¨æ˜¯è”è¡¨æŸ¥è¯¢ä¸­é¦–å…ˆè¢«è¯»å–çš„è¡¨ã€‚
  MySQLä¼šä»Žé©±åŠ¨è¡¨ä¸­è¯»å–æ•°æ®ï¼Œç„¶åŽæ ¹æ®è¿™äº›æ•°æ®åŽ»éžé©±åŠ¨è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…çš„è®°å½•ã€‚
  é€šå¸¸ï¼Œé©±åŠ¨è¡¨åº”è¯¥æ˜¯è¾ƒå°çš„è¡¨ï¼Œæˆ–è€…æ˜¯èƒ½å¤Ÿé€šè¿‡ç´¢å¼•å¿«é€ŸæŸ¥æ‰¾çš„è¡¨ï¼Œä»¥å‡å°‘æŸ¥è¯¢çš„å¼€é”€ã€‚
* **éžé©±åŠ¨è¡¨**ï¼ˆDriven Tableï¼‰ï¼š
  éžé©±åŠ¨è¡¨æ˜¯è”è¡¨æŸ¥è¯¢ä¸­åœ¨é©±åŠ¨è¡¨ä¹‹åŽè¢«è¯»å–çš„è¡¨ã€‚
  MySQLä¼šæ ¹æ®é©±åŠ¨è¡¨ä¸­çš„æ•°æ®åŽ»éžé©±åŠ¨è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…çš„è®°å½•ã€‚
  éžé©±åŠ¨è¡¨é€šå¸¸æ˜¯è¾ƒå¤§çš„è¡¨ï¼Œæˆ–è€…æ˜¯éœ€è¦æ ¹æ®é©±åŠ¨è¡¨ä¸­çš„æ•°æ®è¿›è¡Œå¤šæ¬¡æŸ¥æ‰¾çš„è¡¨ã€‚
* **é€‰æ‹©è¡¨çš„ç­–ç•¥**
    * å°è¡¨é©±åŠ¨å¤§è¡¨ï¼šé€‰æ‹©è¾ƒå°çš„è¡¨ä½œä¸ºé©±åŠ¨è¡¨ï¼Œå› ä¸ºè¯»å–è¾ƒå°çš„è¡¨ä¼šå‡å°‘I/Oæ“ä½œï¼Œä»Žè€Œæé«˜æŸ¥è¯¢æ€§èƒ½ã€‚
    * ç´¢å¼•ä¼˜å…ˆï¼šé€‰æ‹©æœ‰ç´¢å¼•çš„è¡¨ä½œä¸ºé©±åŠ¨è¡¨ï¼Œè¿™æ ·å¯ä»¥åˆ©ç”¨ç´¢å¼•å¿«é€ŸæŸ¥æ‰¾æ•°æ®ã€‚
    * è¿‡æ»¤æ¡ä»¶ï¼šé€‰æ‹©èƒ½å¤Ÿé€šè¿‡è¿‡æ»¤æ¡ä»¶å‡å°‘æ•°æ®é‡çš„è¡¨ä½œä¸ºé©±åŠ¨è¡¨ï¼Œè¿™æ ·å¯ä»¥å‡å°‘åŽç»­è¡¨çš„æŸ¥æ‰¾æ¬¡æ•°ã€‚
* **è§£é‡Šä¸€ä¸‹**ï¼ˆè¿™ä¸ªå¯ä»¥çœ‹å®Œä¸‹é¢çš„è¿žè¡¨åŽŸç†å†æ¥çœ‹è¿™ä¸ªï¼Œä½ å°±çŸ¥é“ä¸ºä»€ä¹ˆé©±åŠ¨è¡¨è¦æœ‰è¿™äº›çº¦æŸäº†ï¼‰ï¼š
    * å› ä¸ºé©±åŠ¨è¡¨æ˜¯è¦å…¨é‡èµ°çš„ï¼Œå¦‚æžœæœ‰whereï¼Œå°±ä¼šå˜æˆrangeæˆ–è€…refï¼Œå…·ä½“è¦çœ‹whereçš„è¿‡æ»¤æ¡ä»¶æœ‰æ²¡æœ‰ç”¨åˆ°ç´¢å¼•ã€‚
    * æ‰€ä»¥åœ¨è¿™ä¸ªåŸºç¡€ä¹‹ä¸Šï¼Œå¦‚æžœé©±åŠ¨è¡¨è¶Šå°ï¼Œé‚£ä¹ˆå…¨è¡¨èµ°çš„æ•°æ®å°±è¶Šå°‘ã€‚å¦‚æžœè¿˜æœ‰whereï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿‡æ»¤æŽ‰ä¸€éƒ¨åˆ†æ•°æ®ï¼Œå¦‚æžœwhereçš„è¿‡æ»¤å­—æ®µè¿˜æœ‰ç´¢å¼•çš„è¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ›´å¿«çš„è¿‡æ»¤æŽ‰ä¸€éƒ¨åˆ†æ•°æ®ã€‚

#### explain ç¤ºä¾‹

| id | select_type | table          | partitions | type        | possible_keys                                            | key                                  | key_len | ref                        | rows   | filtered | Extra                                                                                               |
|----|-------------|----------------|------------|-------------|----------------------------------------------------------|--------------------------------------|---------|----------------------------|--------|----------|-----------------------------------------------------------------------------------------------------|
| 1  | SIMPLE      | father_table   |            | index_merge | uniq_o, index_filed_21, order_code, index_commodity_type | index_filed_21, index_commodity_type | 4,5     |                            | 126595 | 33.33    | Using intersect(index_filed_21, index_commodity_type); Using where; Using temporary; Using filesort |
| 1  | SIMPLE      | children_table |            | ref         | idx_order_code                                           | idx_order_code                       | 202     | mall.new_orders.order_code | 1      | 10       | Using where                                                                                         |

* è¡¨çš„ä½¿ç”¨å’Œè¯»å–ï¼Œä»Žä¸Šå¾€ä¸‹ï¼Œä¾æ¬¡ä½¿ç”¨ã€‚è¿™ä¸ªè¿™ä¸ªæ…¢sqlä¸­ï¼Œfather_tableæ˜¯é©±åŠ¨è¡¨ï¼ˆæ•°æ®é‡å°‘ï¼Œä¼˜åŒ–å™¨å¸®æˆ‘ä»¬åšçš„é€‰æ‹©ï¼‰ï¼Œchildren_tableæ˜¯éžé©±åŠ¨è¡¨ã€‚
  æˆ‘ä»¬é€šè¿‡åœ¨é©±åŠ¨è¡¨ä¸­é€‰æ‹©åˆ—ï¼Œç„¶åŽå–éžé©±åŠ¨è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…çš„è®°å½•ã€‚
* å…¶ä¸­çœ‹çœ‹æˆ‘ä»¬çš„`SQL`
  ,æˆ‘é€‰æ‹©çš„ä¸»è¡¨æ˜¯children_tableè¿™ä¸ªæ•°æ®é‡æ¯”è¾ƒå¤§çš„è¡¨ï¼Œä½†æ˜¯ä¼˜åŒ–å™¨ç»™æˆ‘ä»¬é€‰æ‹©çš„æ˜¯father_tableè¿™ä¸ªå°çš„è¡¨ä½œä¸ºæˆ‘ä»¬çš„é©±åŠ¨è¡¨ã€‚  
  ç„¶åŽfather_tableè¿™ä¸ªè¡¨ä½¿ç”¨`index_merge`**åˆå¹¶ç´¢å¼•**
  è¿›è¡Œä¼˜åŒ–ï¼Œå¸®æˆ‘ä»¬è¿‡æ»¤å‡º126595è¡Œæ•°æ®ï¼Œç„¶åŽè¿›è¡Œè¿žè¡¨æ“ä½œã€‚è¿™ä¸€æ­¥å‡†å¤‡åŽ»è”è¡¨éœ€è¦O(n)çš„æ—¶é—´å¤æ‚åº¦è¿›è¡Œå…¨æ•°æ®çš„éåŽ†   
  å†ç„¶åŽæ˜¯children_tableä½¿ç”¨**idx_order_code**è¿™ä¸ªç´¢å¼•è¿›è¡Œè”è¡¨ï¼ˆè”è¡¨ç®—æ³•æ˜¯**Index Nested-Loop Join**
  ï¼‰ï¼Œé€šè¿‡ç´¢å¼•å¯ä»¥ä½¿ç”¨log(n)çš„æ—¶é—´å¤æ‚åº¦æŸ¥æ‰¾åˆ°éžé©±åŠ¨è¡¨çš„è¡Œæ•°æ®ã€‚
  æ‰€ä»¥ä¸€ä¸ªè”è¡¨çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(nlogN)

### è”è¡¨åŽŸç†

#### åŸºæœ¬åŽŸç†

* å•è¡¨æŸ¥è¯¢ï¼š
  æ ¹æ®WHEREæ¡ä»¶è¿‡æ»¤è¡¨ä¸­çš„è®°å½•ï¼Œç„¶åŽæ ¹æ®SELECTæŒ‡å®šçš„åˆ—è¿”å›žæŸ¥è¯¢ç»“æžœã€‚


* ä¸¤è¡¨è¿žæŽ¥æŸ¥è¯¢ï¼š
  ä½¿ç”¨ONæ¡ä»¶å¯¹ä¸¤è¡¨è¿›è¡Œè¿žæŽ¥å½¢æˆä¸€å¼ è™šæ‹Ÿç»“æžœé›†ï¼›ç„¶åŽæ ¹æ®WHEREæ¡ä»¶è¿‡æ»¤ç»“æžœé›†ä¸­çš„è®°å½•ï¼Œå†æ ¹æ®SELECTæŒ‡å®šçš„åˆ—è¿”å›žæŸ¥è¯¢ç»“æžœã€‚   
  æ³¨æ„âš ï¸è¿™é‡Œâš ï¸ï¼šSQLä¼˜åŒ–å™¨ä¼šå¸®æˆ‘ä»¬åšå¤„ç†ï¼Œè™½ç„¶æˆ‘ä»¬WHEREçš„è¿‡æ»¤æ¡ä»¶å†™åœ¨äº†joinåŽé¢ï¼Œç†è®ºæ¥è¯´æ˜¯å…ˆjoinè¡¨å†è¿‡æ»¤ï¼Œä½†æ˜¯SQLä¼˜åŒ–å™¨å¸®æˆ‘è‡ªåŠ¨ä¼˜åŒ–äº†ï¼Œå°†æˆ‘ä»¬çš„WHEREè¿‡æ»¤æ¡ä»¶æå‰åˆ°joinè¡¨ä¹‹å‰ã€‚
  æ‰€ä»¥æœ€åŽçš„SQLæ˜¯å¯¹é©±åŠ¨è¡¨è¿›è¡ŒWHEREè¿‡æ»¤ç„¶åŽå†åŽ»ç”¨è¿‡æ»¤åŽçš„æ•°é‡é›†è¿›è¡Œjoin


* å¤šè¡¨è¿žæŽ¥æŸ¥è¯¢ï¼ˆå’Œä¸Šé¢çš„è¿‡ç¨‹æ˜¯ä¸€æ ·çš„ï¼‰ï¼š
  å…ˆå¯¹ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªè¡¨æŒ‰ç…§ä¸¤è¡¨è¿žæŽ¥æŸ¥è¯¢ï¼Œç„¶åŽç”¨ç”¨è¿žæŽ¥åŽçš„**è™šæ‹Ÿç»“æžœé›†**å’Œç¬¬ä¸‰ä¸ªè¡¨åšè¿žæŽ¥æŸ¥è¯¢ï¼Œä»¥æ­¤ç±»æŽ¨ï¼Œç›´åˆ°æ‰€æœ‰çš„è¡¨éƒ½è¿žæŽ¥ä¸Šä¸ºæ­¢ï¼Œæœ€ç»ˆå½¢æˆä¸€å¼ 
  **è™šæ‹Ÿç»“æžœé›†**ï¼Œç„¶åŽæ ¹æ®WHEREæ¡ä»¶è¿‡æ»¤è™šæ‹Ÿç»“æžœé›†ä¸­çš„è®°å½•ï¼Œå†æ ¹æ®SELECTæŒ‡å®šçš„åˆ—è¿”å›žæŸ¥è¯¢ç»“æžœã€‚
  å½“ç„¶åœ¨è¿™ä¹‹ä¸­ï¼ŒMysqlä¼˜åŒ–å™¨å¯èƒ½åœ¨è¿žè¡¨çš„è¿‡ç¨‹ä¸­å°±ä½¿ç”¨äº†where ä»Žè€Œä¸ç”¨ç­‰åˆ°èŽ·å¾—æœ€åŽçš„ç»“æžœé›†å†åŽ»åšè¿‡æ»¤ã€‚

### è™šæ‹Ÿçš„ç»“æžœé›†æ˜¯æ€Žä¹ˆæ¥çš„ï¼Ÿ

MySQLæ˜¯åªæ”¯æŒä¸€ç§JOINç®—æ³•Nested-Loop Joinï¼ˆåµŒå¥—å¾ªçŽ¯é“¾æŽ¥ï¼‰ï¼Œä¸åƒå…¶ä»–å•†ä¸šæ•°æ®åº“å¯ä»¥æ”¯æŒå“ˆå¸Œé“¾æŽ¥å’Œåˆå¹¶è¿žæŽ¥ã€‚
æ‰€ä»¥è™šæ‹Ÿè¡¨çš„å»ºç«‹æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªforå¾ªçŽ¯ï¼ŒçŽ°åœ¨ä¸€å…±æ”¯æŒä¸‰ç§Nested_Loop ç­–ç•¥ã€‚

### Simple Nested-Loop Join ï¼ˆç®€å•åµŒå¥—å¾ªçŽ¯ï¼‰

![img](./img/simple.png)   
ç®€å•åµŒå¥—å¾ªçŽ¯éžå¸¸æš´åŠ›ã€‚åœ¨é©±åŠ¨è¡¨ï¼ˆTable blueï¼‰ä¸­è¿›è¡ŒéåŽ†ï¼Œç„¶åŽåœ¨éžé©±åŠ¨è¡¨ï¼ˆTable Redï¼‰ä¸­åšä¸€ä¸ªåµŒå¥—å¾ªçŽ¯ä¾æ¬¡åŒ¹é…æ˜¯å¦ä¸€ä¸€å¯¹åº”ã€‚

### Index Nested-Loop Joinï¼ˆç´¢å¼•åµŒå¥—å¾ªçŽ¯ï¼‰

![img](./img/index.png)    
ç´¢å¼•åµŒå¥—å¾ªçŽ¯è¿˜ç®—ä¸é”™ï¼Œæ˜¯ä¸€ä¸ªO (n*logn)çš„æ—¶é—´å¤æ‚åº¦ã€‚åœ¨éžé©±åŠ¨è¡¨ï¼ˆTable Sï¼‰çš„è¿žæŽ¥å­—æ®µä¸Šå»ºç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œé©±åŠ¨è¡¨ä¾ç„¶æ˜¯å…¨è¡¨éåŽ†ï¼Œä½†æ˜¯é€šè¿‡éžé©±åŠ¨è¡¨ï¼ˆTable
Sï¼‰çš„ç´¢å¼•åŒ¹é…åˆ°å…·ä½“çš„è¡Œã€‚åŒ¹é…éžé©±åŠ¨è¡¨çš„å…·ä½“è¡Œç”±äºŽèµ°çš„æ˜¯ç´¢å¼•ï¼Œæ‰€ä»¥æœç´¢æ—¶é—´å°±æ˜¯log(n) ã€‚
ä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œè¿˜æ˜¯æ¯”è¾ƒé‡è¦çš„ã€‚å¦‚æžœè¿™ä¸ªéžé©±åŠ¨è¡¨ä¸Šçš„ç´¢å¼•å¹¶ä¸æ˜¯ä¸»é”®ç´¢å¼•çš„è¯ï¼ˆä¹Ÿå°±æ˜¯ä¸€ä¸ªsecondary
indexï¼‰ï¼Œå¹¶ä¸”æˆ‘ä»¬éœ€è¦çš„æ•°æ®ä¹Ÿä¸åœ¨è¿™ä¸ªç´¢å¼•å­—æ®µä¸Šçš„è¯ï¼Œæˆ‘ä»¬å°±å¿…é¡»é€šè¿‡å›žè¡¨æ‰èƒ½èŽ·å–åˆ°å¯¹åº”çš„å€¼ã€‚æ‰€ä»¥æ—¶é—´å¤æ‚åº¦æœ€ç»ˆå°±ä¼šå˜æˆOï¼ˆn*
log2nï¼‰ã€‚
åœ¨æœ‰ç´¢å¼•çš„æƒ…å†µä¸‹ï¼ŒMySQLä¼šå°è¯•åŽ»ä½¿ç”¨Index Nested-Loop Joinç®—æ³•ã€‚

### Block Nested-Loop Join ï¼ˆå—åµŒå¥—ç´¢å¼•ï¼‰

![img](./img/block.png)   
Block Nested-Loop Join å¯¹æ¯” Simple Nested-Loop Joinå¤šäº†ä¸€ä¸ªä¸­é—´å¤„ç†çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯join bufferï¼Œä½¿ç”¨join
bufferå°†é©±åŠ¨è¡¨çš„æŸ¥è¯¢JOINç›¸å…³åˆ—éƒ½ç»™ç¼“å†²åˆ°äº†JOIN
BUFFERå½“ä¸­ï¼Œç„¶åŽæ‰¹é‡ä¸Žéžé©±åŠ¨è¡¨è¿›è¡Œæ¯”è¾ƒã€‚è¿™ä¹Ÿæ¥å®žçŽ°çš„è¯ï¼Œå¯ä»¥å°†å¤šæ¬¡æ¯”è¾ƒåˆå¹¶åˆ°ä¸€æ¬¡ï¼Œé™ä½Žäº†éžé©±åŠ¨è¡¨çš„è®¿é—®é¢‘çŽ‡ã€‚ä¹Ÿå°±æ˜¯åªéœ€è¦è®¿é—®ä¸€æ¬¡Sè¡¨ã€‚è¿™æ ·æ¥è¯´çš„è¯ï¼Œå°±ä¸ä¼šå‡ºçŽ°å¤šæ¬¡è®¿é—®éžé©±åŠ¨è¡¨çš„æƒ…å†µäº†ï¼Œä¹Ÿåªæœ‰è¿™ç§æƒ…å†µä¸‹æ‰ä¼šè®¿é—®join
bufferã€‚

--- 

## 3. explainè§£è¯»

å¥½æ–‡ç« ï¼š[MySQLé«˜çº§](ä¸€) EXPLAINç”¨æ³•å’Œç»“æžœåˆ†æž_explain ç”¨æ³•-CSDNåšå®¢   
è¿™ä¸ªè®²çš„å¾ˆå¥½ï¼Œæˆ‘å°±ä¸åˆ—å‡ºæ¥äº†ï¼Œå·æ‡’ä¸€ä¸‹ðŸ˜ðŸ˜ðŸ˜ðŸ˜ðŸ˜ðŸ˜

| id | select_type | table          | partitions | type        | possible_keys                                            | key                                  | key_len | ref                        | rows   | filtered | Extra                                                                                               |
|----|-------------|----------------|------------|-------------|----------------------------------------------------------|--------------------------------------|---------|----------------------------|--------|----------|-----------------------------------------------------------------------------------------------------|
| 1  | SIMPLE      | father_table   |            | index_merge | uniq_o, index_filed_21, order_code, index_commodity_type | index_filed_21, index_commodity_type | 4,5     |                            | 126595 | 33.33    | Using intersect(index_filed_21, index_commodity_type); Using where; Using temporary; Using filesort |
| 1  | SIMPLE      | children_table |            | ref         | idx_order_code                                           | idx_order_code                       | 202     | mall.new_orders.order_code | 1      | 10       | Using where                                                                                         |

ä»Žä¸Šå¾€ä¸‹ä¾æ¬¡ç¡®è®¤é©±åŠ¨è¡¨å’Œéžé©±åŠ¨è¡¨ï¼ˆå°±æ˜¯ä»Žä¸Šå¾€ä¸‹çœ‹ï¼Œæˆ–è€…çœ‹IDï¼‰ï¼š

#### joinè¡¨ç±»åž‹

* `é©±åŠ¨è¡¨`ï¼šfather_table
* `éžé©±åŠ¨è¡¨`ï¼šchildren_table




#### select_type å­—æ®µ

çœ‹ select_type å­—æ®µ:
SIMPLEç±»åž‹ï¼šSIMPLE ç®€å•çš„selectæŸ¥è¯¢ï¼ŒæŸ¥è¯¢ä¸­ä¸åŒ…å«å­æŸ¥è¯¢æˆ–è€…UNION




#### type å­—æ®µ

çœ‹ type å­—æ®µï¼ˆæŸ¥è¯¢ç±»åž‹ï¼‰ï¼š

* `index_merge` ï¼šç´¢å¼•åˆå¹¶ï¼Œä½¿ç”¨å¤šä¸ªç´¢å¼•å¹¶ä½¿ç”¨äº¤é›†è¿‡æ»¤å‡ºéƒ¨åˆ†æ•°æ®ã€‚
* `ref` éžå”¯ä¸€æ€§ç´¢å¼•æ‰«æï¼Œè¿”å›žåŒ¹é…æŸä¸ªå•ç‹¬å€¼çš„æ‰€æœ‰è¡Œï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§ç´¢å¼•è®¿é—®ï¼Œå®ƒè¿”å›žæ‰€æœ‰åŒ¹é…æŸä¸ªå•ç‹¬å€¼çš„è¡Œï¼Œç„¶è€Œï¼Œå®ƒå¯èƒ½ä¼šæ‰¾åˆ°å¤šä¸ªç¬¦åˆæ¡ä»¶çš„è¡Œï¼Œæ‰€ä»¥ä»–åº”è¯¥å±žäºŽæŸ¥æ‰¾å’Œæ‰«æçš„æ··åˆä½“ã€‚æœ‰å¯èƒ½éœ€è¦å›žè¡¨ã€‚
* `const` å¸¸é‡æŸ¥è¯¢
* `eq_ref` ä½¿ç”¨å”¯ä¸€ç´¢å¼•
* `range` èŒƒå›´æŸ¥è¯¢
* `index` å…¨ç´¢å¼•æ‰«æ




#### key å­—æ®µ

çœ‹ key å­—æ®µï¼ˆå…·ä½“ä½¿ç”¨çš„ç´¢å¼•ï¼‰

ä¸¤å¼ è¡¨ä½¿ç”¨çš„ç´¢å¼•ä¸åŒï¼š

* father_table ä½¿ç”¨ç´¢å¼•åˆå¹¶ï¼ˆç”¨äº†index_filed_21å’Œindex_commodity_typeï¼‰
* children_table ç”¨äº† idx_order_code ç´¢å¼• ï¼ˆorder_codeå­—æ®µï¼‰




#### row å­—æ®µ ï¼ï¼ï¼ çœ‹è¿™ä¸ªæœ€æœ€æœ€é‡è¦

çœ‹ rows å­—æ®µï¼ˆæ‰«æå‡ºçš„è¡Œï¼‰
å¤§è‡´ä¼°ç®—å‡ºæ‰¾åˆ°æ‰€éœ€çš„è®°å½•æ‰€éœ€è¦è¯»å–çš„è¡Œæ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨çš„è¶Šå°‘è¶Šå¥½




#### extra å­—æ®µ

çœ‹ extra å­—æ®µï¼ˆé¢å¤–è¯´æ˜Žï¼‰

* `using where`ï¼šä½¿ç”¨where è¿›è¡Œäº†è¿‡æ»¤ ï¼ˆæ¬¡å¸Œæœ›çœ‹è§ï¼‰
* `using index`ï¼šç›´æŽ¥é€šè¿‡ç´¢å¼•æ‰¾åˆ°æŸ¥è¯¢çš„å€¼ï¼Œæ— éœ€å›žè¡¨ ï¼ˆæœ€å¸Œæœ›çœ‹è§ï¼‰
    * å¦‚æžœåŒæ—¶å‡ºçŽ°using whereï¼Œè¡¨æ˜Žç´¢å¼•è¢«ç”¨æ¥æ‰§è¡Œç´¢å¼•é”®å€¼çš„æŸ¥æ‰¾
    * å¦‚æžœæ²¡æœ‰åŒæ—¶å‡ºçŽ°using whereï¼Œè¡¨æ˜Žç´¢å¼•ç”¨æ¥è¯»å–æ•°æ®è€Œéžæ‰§è¡ŒæŸ¥æ‰¾åŠ¨ä½œ
* `using temporary` : ä½¿ç”¨äº†ä¸´æ—¶è¡¨ï¼Œè¿›è¡Œ order by æˆ–è€…group by
* `using intersect`ï¼šä½¿ç”¨äº†äº¤é›†ï¼Œå› ä¸ºæˆ‘ä»¬å‰é¢ä½¿ç”¨çš„index_mergeï¼Œæ‰€ä»¥å–çš„æ˜¯ä¸¤ä¸ªç´¢å¼•æŸ¥è¯¢ç»“æžœçš„äº¤é›†
* `using filesort`ï¼šmysqlä¼šå¯¹æ•°æ®ä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨çš„ç´¢å¼•æŽ’åºï¼Œè€Œä¸æ˜¯æŒ‰ç…§è¡¨å†…çš„ç´¢å¼•é¡ºåºè¿›è¡Œè¯»å–ã€‚å½“æŽ’åºæ“ä½œæ— æ³•é€šè¿‡å½“å‰ç´¢å¼•ç›´æŽ¥å®Œæˆ,å°±éœ€è¦ä½¿ç”¨é¢å¤–çš„æŽ’åºæ­¥éª¤
  ï¼ˆè¿™ä¸ªä¸å¸Œæœ›çœ‹è§ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦é‡æ–°èµ°ä¸€ä¸ªæ–°çš„ç´¢å¼•è¿›è¡ŒæŽ’åºï¼Œå°±æ˜¯ä¸€æ¬¡å›žè¡¨äº†ï¼‰
* `using index condition`:ç´¢å¼•ä¸‹æŽ¨ï¼Œ Using Index Conditionæ˜¯ MySQL 5.6
  åŠæ›´é«˜ç‰ˆæœ¬å¼•å…¥çš„ä¸€ä¸ªæ–°ç‰¹æ€§ã€‚å½“MySQLä½¿ç”¨è¿™ä¸ªç­–ç•¥æ—¶ï¼Œå®ƒä¼šåœ¨ç´¢å¼•æ‰«ææœŸé—´åº”ç”¨WHEREå­å¥çš„æ¡ä»¶ï¼Œè€Œä¸æ˜¯åœ¨æ‰«æå®Œæ•´ä¸ªè¡¨åŽå†è¿‡æ»¤ç»“æžœé›†ã€‚

```sql

# è¿™ä¸ªsqlè¯­å¥ çœ‹extra ç»“æžœå°±æœ‰using index ï¼Œusing where ç›´æŽ¥é€šè¿‡ç´¢å¼•å°±å¯ä»¥ç›´æŽ¥æ‹¿åˆ°å€¼äº†
# å¦‚æžœå°†select order_code æ”¹æˆselect * å°±åªæœ‰using where ï¼Œ åªèƒ½å¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤ï¼Œå…·ä½“çš„å€¼çš„èŽ·å–è¿˜éœ€è¦å›žè¡¨
explain
select code
from children_table
where code > 1000000000000000
limit 10;

```

--- 

## 4. ç»§ç»­è§£è¯»ï¼ˆå¦‚ä½•åŽ»é™¤filesortï¼Œå…ˆå°è¯•è¿›è¡Œç¬¬ä¸€æ­¥ä¼˜åŒ–ï¼ŒåŽ»é™¤å¤–éƒ¨ç´¢å¼•æŽ’åºï¼‰

1. å¦‚ä½•åŽ»é™¤ filesortã€‚ä¸‹é¢æ˜¯æˆ‘æ”¹çš„sqlã€‚ï¼ˆselect * å°±æ˜¯ä¸Šé¢ðŸ‘†æœ€å¼€å§‹çš„æŸ¥è¯¢å­—æ®µï¼Œæˆ‘åˆå·æ‡’äº†ðŸ˜ï¼‰

```sql
SELECT *
FROM `children_table`
         INNER JOIN `father_table`
    USE INDEX (index_updated_at)
                    ON `father_table`.`order_code` = `bb`.`order_code`

WHERE `father_table`.`commodity_type` = '1'
  AND `father_table`.`filed_21` = '1'
  AND `father_table`.`updated_at` >= '2023-06-01'
  AND `children_table`.`deleted_at` IS NULL
ORDER BY `father_table`.`updated_at` DESC
LIMIT 100;
```

| id | select_type | table          | partitions | type  | possible_keys    | key              | key_len | ref                        | rows | filtered | Extra                              |
|----|-------------|----------------|------------|-------|------------------|------------------|---------|----------------------------|------|----------|------------------------------------|
| 1  | SIMPLE      | father_table   |            | range | index_updated_at | index_updated_at | 6       |                            | 5932 | 1        | Using index condition; Using where |
| 1  | SIMPLE      | children_table |            | ref   | idx_order_code   | idx_order_code   | 202     | mall.new_orders.order_code | 1    | 10       | Using where                        |

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨USE INDEX å‘Šè¯‰MySQLçš„ä¼˜åŒ–å™¨ä½¿ç”¨`index_updated_at`
ç´¢å¼•æ¥å¯¹æˆ‘ä»¬çš„è¡¨è¿›è¡Œè¿‡æ»¤ï¼Œè€Œä¸æ˜¯ä¼˜åŒ–å™¨è‡ªå·±åˆ¤æ–­çš„ä½¿ç”¨`index merge` **ç´¢å¼•åˆå¹¶** ã€‚   
è¿™æ ·æˆ‘ä»¬åœ¨order
byçš„æ—¶å€™å°±å¯ä»¥ç›´æŽ¥ä½¿ç”¨index_updated_atè¿™ä¸ªç´¢å¼•è¿›è¡ŒæŽ’åºäº†ï¼Œè€Œä¸éœ€è¦ä½¿ç”¨å¤–éƒ¨ç´¢å¼•ï¼ˆä¸€èˆ¬æ¥è¯´å¤–éƒ¨ç´¢å¼•æŽ’åºéƒ½ç”¨idæ¥æŽ’åºï¼‰ã€‚   
è¿™æ ·æˆ‘ä»¬æ¥çœ‹EXPLAINçš„ç»“æžœï¼Œ Using filesortå°±æ¶ˆå¤±äº†ã€‚ï¼ˆ`index_updated_at`æ˜¯updated_atè¿™ä¸ªå­—æ®µçš„ç´¢å¼•ï¼‰

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¤§å®¶éƒ½ä¼šè¯´å»ºè®®ç»™ORDER BYçš„å­—æ®µåŠ ä¸Šç´¢å¼•ã€‚âš ï¸ï¸ï¸ï¸âš ï¸ï¸ï¸ï¸âš ï¸ï¸ï¸ï¸    
**å› ä¸ºç´¢å¼•ä¸Šçš„å€¼æ˜¯æœ‰åºçš„ï¼Œå½“é€šè¿‡ç´¢å¼•æŸ¥æ‰¾çš„å¶å­ç»“ç‚¹çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç›´æŽ¥æ‰¾åˆ°ORDER
BYçš„èµ·å§‹ä½ç½®æˆ–è€…ç»ˆæ­¢ä½ç½®ï¼Œç„¶åŽåœ¨å¶å­ç»“ç‚¹çš„åŒå‘è”è¡¨ç›´æŽ¥è¿›è¡ŒéåŽ†å°±å¯ä»¥äº†ï¼Œè¿žæŽ’åºéƒ½çœç•¥äº†ã€‚**

**æ€»ç»“**ï¼šå¦‚æžœæœ‰order byçš„éœ€æ±‚æœ€å¥½ä½¿ç”¨order
byçš„å­—æ®µä¸ºç´¢å¼•é”®ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘ä¸€æ¬¡æŽ’åºå’Œå›žè¡¨ï¼Œè¿™æžå¤§çš„ä¼˜åŒ–æˆ‘ä»¬çš„SQLæ‰§è¡Œæ—¶é—´ã€‚ï¼ˆåœ¨åˆ†é¡µæŸ¥è¯¢ä¸­ï¼Œå½“é¡µæ•°å¾ˆæ·±ï¼ŒåŒæ—¶è¦å€’æŽ’åºçš„è¯ï¼Œé‚£ä¹ˆå‡†å¤‡æŽ’åºçš„æ•°æ®å°±ä¼šéžå¸¸å¤§ï¼Œè¿™å°†å¯¼è‡´æŽ’åºæ—¶é—´å¾ˆé•¿ï¼ŒSQLæ…¢ï¼‰   
åŒæ—¶æ³¨æ„ä½¿ç”¨order by è¦è®©å¾…æŽ’åºçš„å­—æ®µåœ¨whereä¸­ä½¿ç”¨ç´¢å¼•ï¼Œä¸ç„¶æœ€ç»ˆä¹Ÿåªèƒ½å˜ä¸ºå¤–éƒ¨ç´¢å¼•æŽ’åºï¼Œå¯¹äºŽåŠ é€Ÿç´¢å¼•èµ·ä¸åˆ°ä½œç”¨ã€‚ 

**å»ºè®®**ï¼šä½¿ç”¨IDè¿›è¡Œorder byçš„æŽ’åºï¼ŒIDéœ€è¦è‡ªå¢žã€‚ä¹Ÿå¯ä»¥ç”¨å…¶ä»–å­—æ®µï¼Œä½†æ˜¯å­—æ®µå€¼éœ€è¦è‡ªå¢žæˆ–è€…åŸºæœ¬è‡ªå¢žï¼ˆé›ªèŠ±ç®—æ³•ï¼‰ã€‚

----

## 5ã€é¢å¤–æµ‹è¯•

æ²¡æœ‰æ£€ç´¢æ¡ä»¶ï¼Œç›´æŽ¥å€’æŽ’åº

```sql

select *
from children_table
         inner join father_table on children_table.order_code = father_table.order_code
order by children_table.updated_at desc

limit 100;
```

| table          | partitions | type   | possible_keys     | key    | key_len | ref                              | rows  | filtered | Extra          |
|----------------|------------|--------|-------------------|--------|---------|----------------------------------|-------|----------|----------------|
| children_table | null       | ALL    | idx_order_code    | null   | null    | null                             | 42424 | 100      | Using filesort |
| father_table   | null       | eq_ref | uniq_o,order_code | uniq_o | 202     | mall.new_orders_items.order_code | 1     | 100      | null           |

æˆ‘ä»¬æ¥çœ‹è¿™ä¸ªSQLï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„çŽ°è±¡ã€‚æ­¤æ—¶æˆ‘ä»¬å¹¶æ²¡æœ‰ç»™children_tableçš„updated_atå¢žåŠ ç´¢å¼•ï¼Œç„¶åŽæˆ‘ä»¬çœ‹çœ‹EXPLAINçš„æ‰§è¡Œç»“æžœã€‚
å±…ç„¶æ˜¯children_tableèµ°äº†å…¨è¡¨æ‰«æï¼Œè¿™ä¸ªå°±ååˆ†ææ€–äº†ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰è¡¨çš„æ•°æ®é‡æ›´å°çš„father_tableï¼Ÿ    
**é‚£æ˜¯å› ä¸ºfather_tableçš„order_codeå­—æ®µæ˜¯å”¯ä¸€ç´¢å¼•ï¼ˆeq_refï¼‰ã€‚**   
è¿™ä¸ªç´¢å¼•ç­‰çº§éžå¸¸é«˜ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨joinçš„æ—¶å€™ï¼Œfather_tableå¯ä»¥ç›´æŽ¥æ‰¾åˆ°éœ€è¦æŸ¥è¯¢çš„æ•°æ®è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹filteredï¼ˆè¡¨ç¤ºè¿”å›žç»“æžœçš„è¡Œæ•°å è¯»å–è¡Œæ•°çš„ç™¾åˆ†æ¯”ï¼‰çš„è¿‡æ»¤çŽ‡æ˜¯100%ã€‚
åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼ŒMySQLçš„ä¼˜åŒ–å™¨å°±ä¼šä½¿ç”¨ç´¢å¼•ç­‰çº§æ›´é«˜çš„è¡¨ä½œä¸ºæˆ‘ä»¬çš„éžé©±åŠ¨è¡¨ï¼Œä»Žè€Œç†è®ºä¸ŠåŠ é€Ÿæˆ‘ä»¬çš„è”è¡¨é€Ÿåº¦ã€‚ä½†æ˜¯å¯æƒ³è€ŒçŸ¥ï¼Œæˆ‘ä»¬children_tableçš„æ•°æ®é‡æ›´å¤§ï¼Œå…¨é‡èµ°è¡¨é€Ÿåº¦æ…¢å¾ˆå¤šã€‚   
ä½†æ˜¯è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œå°±ç®—æˆ‘ä»¬æ²¡æœ‰ç»™children_table.updated_atåŠ ç´¢å¼•ï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰ä¸»é”®ï¼Œè¿™ä¸ªä¸»é”®æˆ‘ä»¬éš¾é“ç”¨ä¸äº†å—ï¼Ÿ    
è¯¶ï¼Œä½ æƒ³åˆ°äº†ï¼Œå…¶å®žæ˜¯å¯ä»¥çš„ðŸ˜ðŸ¤”ã€‚ä½†æ˜¯æˆ‘ä»¬å¿…é¡»ä½¿ç”¨whereæˆ–è€…order byçš„æ—¶å€™ä½¿ç”¨è¿™è¿™ä¸ªå­—æ®µï¼Œè¿™æ ·æ‰å¯ä»¥ä½¿ç”¨åˆ°ä¸»é”®ç´¢å¼•ã€‚æ‰€ä»¥SQLå°±ä¼šå˜æˆä¸‹é¢è¿™ä¸ªæ ·å­ðŸ‘‡ã€‚

```sql
select new_orders_items.noto_wms_amount
from new_orders_items
         inner join new_orders on new_orders_items.order_code = new_orders.order_code
order by new_orders_items.id desc
limit 100;
```

| id | select_type | table          | partitions | type   | possible_keys     | key     | key_len | ref                              | rows | filtered | Extra       |
|----|-------------|----------------|------------|--------|-------------------|---------|---------|----------------------------------|------|----------|-------------|
| 1  | SIMPLE      | children_table | null       | index  | idx_order_code    | PRIMARY | 8       | null                             | 100  | 100      |             |
| 1  | SIMPLE      | father_table   | null       | eq_ref | uniq_o,order_code | uniq_o  | 202     | mall.new_orders_items.order_code | 1    | 100      | using index |

å› ä¸ºorder byçš„å­—æ®µæœ‰ç´¢å¼•ï¼ˆä¸»é”®ç´¢å¼•==> cluster index
ï¼‰æ‰€ä»¥SQLåˆ†æžå™¨å°±å¸®æˆ‘ä»¬ä½¿ç”¨äº†ä¸»é”®è¿›è¡ŒæŸ¥è¯¢å’ŒæŽ’åºã€‚çœ‹æˆ‘ä»¬çš„EXPLAINæ‰§è¡Œè®¡åˆ’ï¼Œæˆ‘ä»¬çš„children_tableçš„typeæ˜¯indexã€‚   
å› ä¸ºæˆ‘ä»¬æ²¡æœ‰å…¶ä»–è¿‡æ»¤æ¡ä»¶ï¼Œç›´æŽ¥æ ¹æ®idè¿›è¡ŒæŽ’åºçš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æŽ¥é€‰æ‹©idæœ€å¤§çš„100ä¸ªæ•°æ®å°±å¥½äº†ï¼Œç›´æŽ¥çœ‹æˆ‘ä»¬çš„rowsæ˜¯100ï¼Œå¯è§éžå¸¸éžå¸¸é«˜æ•ˆã€‚è¿™ä¸ªè·Ÿfather_tableçš„60wæ•°æ®æ¯”è¾ƒè‚¯å®šæ˜¯æ²¡æœ‰å¯æ¯”æ€§çš„ï¼Œæ‰€ä»¥SQLä¼˜åŒ–å™¨ä½¿ç”¨children_tableä½œä¸ºæˆ‘ä»¬çš„é©±åŠ¨è¡¨

--- 

## 6ã€USE INDEX å’Œ FORCE INDEXçš„æ³¨æ„äº‹é¡¹

åœ¨ä¸€ä¸ªå¤æ‚SQLä¸­ï¼Œé™¤éžæœ‰100%çš„æŠŠæˆ‘ðŸ«´ï¼Œä¸ç„¶æˆ‘ä»¬ç¦æ­¢ä½¿ç”¨FORCE INDEX æˆ–è€… USE INDEXã€‚

* FORCE INDEXï¼šå¼ºåˆ¶ä½¿ç”¨æŸä¸€ä¸ªç´¢å¼•
* USE INDEXï¼šè®©MySQLåªåœ¨è¿™å‡ ç§SQLä¸­è¿›è¡Œé€‰æ‹©ï¼Œé€‰æ‹©åˆé€‚çš„ä¸€ä¸ªSQLæˆ–è€…æ˜¯index mergeç´¢å¼•åˆå¹¶çš„å½¢å¼è¿›è¡ŒæŸ¥è¯¢

ä¸ºä»€ä¹ˆä¸å»ºè®®ä½¿ç”¨è¿™ä¸¤ä¸ªï¼Ÿ

å› ä¸ºç´¢å¼•çš„é€‰åˆ™è·Ÿæˆ‘ä»¬æŸ¥è¯¢çš„æ•°æ®é‡ã€whereé€‰æ‹©çš„å­—æ®µã€joinçš„è¡¨ã€order
byçš„å­—æ®µæœ‰å¾ˆå¤§çš„å…³ç³»ã€‚å¯¹äºŽä¸€ä¸ªåˆ—è¡¨é¡µçš„æ£€ç´¢ï¼Œæ£€ç´¢æ¡ä»¶çš„å¤šå°‘åˆå‰ç«¯ä¼ å…¥çš„å‚æ•°ç¡®å®šã€‚  
å¦‚æžœä¼ å…¥å‚æ•°å¤šï¼Œé‚£ä¹ˆsqlçš„whereçš„é™å®šå­—æ®µå°±ä¼šå˜å¤šï¼Œé‚£ä¹ˆå…·ä½“é€‰æ‹©å“ªä¸€ä¸ªç´¢å¼•èƒ½å¤Ÿå¾—åˆ°æœ€å°çš„rowsï¼ˆæœ€å¤§è¿‡æ»¤ï¼‰ï¼Œå°±å¾—æ ¹æ®å®žé™…æ•°æ®é‡å’Œæ£€ç´¢æ¡ä»¶æ¥ç¡®å®šã€‚   
ç´¢å¼•çš„é€‰æ‹©æ˜¯ç”±MySQLä¼˜åŒ–å™¨å†³å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ä¸ä½¿ç”¨FORCE INDEX æˆ–è€… USE INDEXã€‚å¦‚æžœè¦ä½¿ç”¨çš„è¯ï¼Œè¯´æ˜ŽæŸ¥è¯¢åœºæ™¯æ¯”è¾ƒå•ä¸€ï¼Œæ‰å¯ä»¥ä½¿ç”¨ã€‚

## 7ã€æ·±åº¦åˆ†é¡µ+order byçš„é—®é¢˜ï¼ï¼ï¼

### æ·±åº¦åˆ†é¡µ

æˆ‘ä»¬é‡ç‚¹ å…³æ³¨ OFFSET 111200
å¯¹äºŽåˆ†é¡µæ¥è¯´ï¼Œå¦‚æžœæˆ‘ä»¬æƒ³è¦æ‹¿åˆ° 111200 æ¡åŽé¢çš„æ•°æ®ã€‚æ˜¯å…ˆæŸ¥è¯¢offset+limitæ¡æ•°æ®ï¼Œå†å°†offsetæ¡æ•°æ®ä¸¢å¼ƒç»™ç”¨æˆ·è¿”å›žå‰©ä¸‹çš„limitæ¡æ•°æ®ã€‚æ¯”å¦‚limit
10000,10å®žé™…ä¸Šæ˜¯mysqlæŸ¥æ‰¾åˆ°å‰10010æ¡æ•°æ®ï¼Œä¹‹åŽä¸¢å¼ƒå‰é¢çš„10000è¡ŒåŽå†è¿”å›ž
è¿™æ ·å­å½“åç§»é‡å¾ˆå°æ—¶ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¾ˆå¿«ï¼Œä½†æ˜¯éšç€ offset å˜å¤§æ—¶ï¼ŒæŸ¥è¯¢é€Ÿåº¦ä¼šè¶Šæ¥è¶Šæ…¢ï¼Œå› ä¸ºæŸ¥æ‰¾çš„æ•°æ®è¶Šæ¥è¶Šå¤š

```sql
explain
select id
from father_table
order by father_table.updated_at
LIMIT 100 OFFSET 111200;
```

| id | select_type | table      | partitions | type  | possible_keys | key              | key_len | ref  | rows | filtered | Extra       |
|----|-------------|------------|------------|-------|---------------|------------------|---------|------|------|----------|-------------|
| 1  | SIMPLE      | new_orders | null       | index | null          | index_updated_at | 6       | null | 1010 | 100      | Using index |

çœ‹æˆ‘ä»¬çš„ä¾‹å­ï¼Œä½¿ç”¨`limit 1000,10` ï¼Œå°±æ˜¯å…ˆèŽ·å–å‡º1010è¡Œæ•°æ®ï¼Œç„¶åŽè¿”å›žæœ€åŽçš„10è¡Œã€‚    
æ‰€ä»¥çœ‹æˆ‘ä»¬çš„`LIMIT 100 OFFSET 111200`ï¼Œæˆ‘ä»¬åªè¦æœ€åŽçš„100è¡Œæ•°æ®ï¼Œä½†æ˜¯éœ€è¦è‡³å°‘æ‹¿
111300çš„æ•°æ®ï¼Œè¿™æ ·ä¸€çœ‹æ…¢SQLçš„é—®é¢˜æ˜¯ä¸æ˜¯æ˜¾è€Œæ˜“è§ï¼Œæˆ‘æ‹¿é‚£ä¹ˆå¤šæ•°æ®å¹²ä»€ä¹ˆå¯¹å§ã€‚è¿™äº›å¤šä½™çš„æ•°æ®è¿˜è¦æ”¾åˆ°buffer poolçš„ç¼“å­˜åŒºä¸­
ï¼ˆå‡†ç¡®æ¥è¯´**buffer pool çš„old åŒºåŸŸ**ï¼Œå¯¹äºŽè¿™éƒ¨åˆ†è¯»äº†çš„ä½†æ˜¯æ²¡æœ‰è®¿é—®çš„æ•°æ®ï¼Œmysqlä¼šåœ¨LRUç®—æ³•ä¸‹æ”¾åˆ°oldåŒºåŸŸï¼Œä½œä¸ºç¼“å­˜ï¼ŒåŒæ—¶é˜²æ­¢å‡ºçŽ°
**ç¼“å­˜æ±¡æŸ“**ï¼Œå½“è¿™éƒ¨åˆ†ç¼“å­˜åœ¨1såŽç¬¬äºŒæ¬¡è¢«è®¿é—®çš„è¯ï¼Œå°±ä¼šè¢«æ”¾å…¥åˆ°youngåŒºåŸŸæˆä¸ºçƒ­ç‚¹ç¼“å­˜ï¼Œç®€å•æ‹“å±•ä¸€ä¸‹ï¼‰

**è§£å†³æ€è·¯ ï¼ˆæ·±åº¦åˆ†é¡µçš„é€šå¸¸è§£æ³•ï¼‰**

**æœ¬è´¨ä¸Šæ˜¯é™å®šæ•°æ®å¤§å°ï¼Œç›´æŽ¥é€šè¿‡where å¯¹æ•°æ®é‡è¿›è¡Œè¿‡æ»¤ï¼Œå°†æˆ‘ä»¬OFFSETçš„æ•°æ®é‡å˜å°ï¼Œè¿™æ ·æˆ‘ä»¬çš„åˆ†é¡µå°±ä¼šè¾¹å¿«å¾ˆå¤šäº†**

* where è¿›è¡Œè¿‡æ»¤

```sql 
select *
from t1
where id >= 300000
limit 10
```

* join è¿žè¡¨çš„æ—¶å€™ç›´æŽ¥è¿‡æ»¤

```sql
select *
from t1 as a
         inner join (select id from t1 limit 300000, 10) as b
                    on a.id = b.id
limit 10
```

* åµŒå¥—æŸ¥è¯¢

```sql
select *
from t1
where id > (select id from t1 limit 300000, 1)
limit 10
```

### ORDER BY

å†å…³æ³¨ order by å­—æ®µ
å¯¹äºŽorder by
ï¼Œæˆ‘ä»¬ä¸€å®šæ˜¯å°†æ‰€æœ‰ç¬¦åˆæ£€ç´¢æ¡ä»¶çš„æ•°æ®å…¨éƒ¨æ‹¿å‡ºæ¥ï¼Œç„¶åŽå†åŽ»åšæŽ’åºã€‚æ‰€ä»¥å¦‚æžœè¿‡æ»¤å‡ºæ¥çš„æ•°æ®é‡å¾ˆå¤§çš„è¯ï¼Œé‚£ä¹ˆå¾…æŽ’åºçš„æ•°æ®é‡å°±ä¼šå¾ˆå¤§ï¼ˆO(
nlogN)çš„æ—¶é—´å¤æ‚åº¦ï¼‰ã€‚   
æ­¤æ—¶æ³¨æ„ï¼Œä¸€èˆ¬æ¥è¯´order by å’Œ åˆ†é¡µæ˜¯ä¸€èµ·å‡ºçŽ°çš„ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚é€šå¸¸æ˜¯æ˜¾ç¤ºæœ€æ–°çš„æ•°æ®ï¼Œæ‰€ä»¥åŒæ—¶ä¼šå¯¹æ—¶é—´è¿›è¡Œå€’æŽ’åºã€‚  
é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œå¦‚æžœæ·±åº¦åˆ†é¡µ+order byä¸€èµ·å‡ºçŽ°çš„è¯ï¼Œé—®é¢˜å°±å¾ˆä¸¥é‡äº†ã€‚ðŸ˜¨ðŸ˜¨ðŸ˜¨ðŸ˜¨   
æ·±åº¦åˆ†é¡µå‡ºçŽ°ä¸€å®šä»£è¡¨æ•°æ®é‡å¾ˆå¤§ï¼Œæ‰€ä»¥order byå¾…æŽ’åºçš„æ•°æ®å°±ä¼šå¾ˆå¤§ã€‚æ­¤æ—¶å› ä¸ºæ•°æ®é‡å˜å¤šï¼Œorder by çš„æ‰§è¡Œä¹‹é—´å°±ä¼šå»¶é•¿ï¼Œæœ€ç»ˆå¯¼è‡´æ…¢SQLã€‚


---

## 8. å®žé™…é—®é¢˜æ…¢SQLæ€»ç»“ï¼ˆå°±ä¸‰ä¸¤å¥è¯ï¼‰

æ‰€ä»¥æˆ‘ä»¬è¿™ä¸ªæ…¢SQLçš„æ ¸å¿ƒåŽŸå› æ˜¯å‡ºçŽ°äº† **æ·±åº¦åˆ†é¡µçš„åœºæ™¯**  ï¼Œå…¶è¡¨ç¤ºæ•°æ®é‡å¾ˆå¤§ ã€‚

ç„¶åŽåŒæ—¶å­˜åœ¨**order byçš„å€’æŽ’åº** ï¼Œä½¿å¾—å¾…æŽ’åºçš„æ•°æ®é‡æžå¤§ï¼Œæœ€ç»ˆå¯¼è‡´æŽ’åºæ—¶é—´é•¿ã€‚

æ­¤å¤–order by æŽ’åºä½¿ç”¨çš„æ˜¯ **å¤–éƒ¨ç´¢å¼•æŽ’åº** ï¼Œæ— æ³•ä½¿ç”¨whereæ¡ä»¶ç”¨åˆ°çš„ç´¢å¼•ç›´æŽ¥è¿›è¡ŒæŽ’åºï¼Œéœ€è¦å›žè¡¨ã€‚

---

## 9. æœ¬æ¬¡æ…¢SQLçš„è§£å†³æ€è·¯

è¯ä¸å¤šè¯´ç›´æŽ¥å†™SQL

### ç¬¬ä¸€æ­¥ å‡å°‘é©±åŠ¨è¡¨è”è¡¨å‰çš„æ‰«æèŒƒå›´

æˆ‘ä»¬ç›´æŽ¥ä¼˜å…ˆæŸ¥å‡ºç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€æ¡æ•°æ®idå’Œæœ€åŽä¸€ä¸ªidï¼Œç„¶åŽè¿›è¡Œè¿‡æ»¤ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬åœ¨whereçš„è¿‡æ»¤æ¡ä»¶ä¸­ä½¿ç”¨äº†idï¼Œç„¶åŽmysqlå°±ä¼šä¼˜å…ˆå¹¶ä½¿ç”¨idè¿›è¡Œè¿‡æ»¤ã€‚ä»Žè€Œå°†æˆ‘ä»¬joinè”è¡¨æ—¶å€™æ‰«æçš„è¡¨çš„æ•°é‡å‡å°‘ã€‚

é€šè¿‡ä¸‹é¢è¿™ä¸ªæ–°çš„SQLðŸ‘‡

```sql
SELECT `father_table`.`filed_1`,
       `father_table`.`order_code`,
       `father_table`.`filed_2`,
       `father_table`.`filed_3`,
       `father_table`.`filed_4`,
       `father_table`.`filed_5`,
       `father_table`.`filed_6`,
       `father_table`.`order_time`,
       `father_table`.`commodity_type`,
       `father_table`.`filed_7`,
       `father_table`.`filed_8`,
       `father_table`.`filed_10`,
       `father_table`.`filed_11`,
       `children_table`.`filed_12`,
       `children_table`.`filed_13`,
       `children_table`.`filed_14`,
       `children_table`.`filed_15`,
       `children_table`.`filed_16`,
       `children_table`.`filed_17`,
       `children_table`.`filed_18`,
       `children_table`.`filed_19`,
       `children_table`.`filed_20`,
       `children_table`.`id` AS `children_table_id`
FROM `children_table`
         INNER JOIN `father_table` ON `father_table`.`order_code` = `children_table`.`order_code`
WHERE `father_table`.`commodity_type` = '1'
  AND `father_table`.`filed_21` = '1'
  AND `father_table`.`order_time` >= '2023-06-01'
  AND `father_table`.`id` >= 456079
  AND `father_table`.`id` <= 654277
  AND `children_table`.`deleted_at` IS NULL
ORDER BY `children_table`.`created_at` DESC
LIMIT 100 OFFSET 111200;



# `father_table`.`id` <= 466125 æ¥è‡ªäºŽ ä¸‹é¢ðŸ‘‡çš„min 
# `father_table`.`id` <= 654277 æ¥è‡ªäºŽ ä¸‹é¢ðŸ‘‡
SELECT min(father_table.id), MAX(father_table.id)
FROM `children_table`
         INNER JOIN `father_table` ON `father_table`.`order_code` = `children_table`.`order_code`
WHERE `father_table`.`commodity_type` = '1'
  AND `father_table`.`business_id` = '1'
  AND `father_table`.`order_time` >= '2023-06-01'
  AND `children_table`.`deleted_at` IS NULL;

```

æ‰§è¡Œæ•ˆçŽ‡æ˜¾ç¤ºï¼šå¯¹æ¯”ä¸€ä¸‹ rowsçš„æ‰«æè¡Œæ•°ï¼Œä»ŽåŽŸå…ˆçš„`126595` ä¸‹é™è‡³ `38818`,å› ä¸ºæˆ‘ä»¬é™å®šäº†fatherçš„æ‰«æåŒºé—´ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜å¯ä»¥ä¼˜åŒ–ï¼Œå› ä¸ºorder
byçš„ä¾ç„¶èŽ·å–çš„ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„å…¨é‡æ•°æ®ã€‚    
æ‰§è¡Œé€Ÿåº¦ä»Ž**2.4sä¸‹é™åˆ°1.6s**ã€‚

| id | select_type | table          | partitions | type        | possible_keys                                                        | key                                     | key_len | ref                        | rows  | filtered | Extra                                                                                                  |
|----|-------------|----------------|------------|-------------|----------------------------------------------------------------------|-----------------------------------------|---------|----------------------------|-------|----------|--------------------------------------------------------------------------------------------------------|
| 1  | SIMPLE      | father_table   | null       | index_merge | PRIMARY, uniq_o, index_business_id, order_code, index_commodity_type | index_commodity_type, index_business_id | 13,12   | null                       | 38818 | 33.33    | Using intersect(index_commodity_type, index_business_id); Using where; Using temporary; Using filesort |
| 1  | SIMPLE      | children_table | null       | ref         | idx_order_code                                                       | idx_order_code                          | 202     | mall.new_orders.order_code | 1     | 10       | Using where                                                                                            |

### ç¬¬äºŒæ­¥ ä¼˜åŒ–order byæŽ’åº

æŒ‰ç…§æœ€å¼€å§‹æˆ‘ä»¬è°ˆè®ºåˆ°çš„using
filesortï¼ŒçŽ°åœ¨ä½¿ç”¨created_atç”¨çš„æ˜¯å¤–éƒ¨ç´¢å¼•æŽ’åºã€‚è¿™æ˜¾ç¤ºä¸åˆç†ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æœ‰ç´¢å¼•é”®çš„å­—æ®µã€‚é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥ç”¨å“ªä¸€ä¸ªå‘¢ï¼Ÿç­”æ¡ˆå¾ˆæ˜Žæ˜¾äº†ï¼Œä½¿ç”¨idã€‚   
æŒ‰ç…§ä¸Šé¢çš„æ€è·¯ï¼Œæˆ‘ä»¬å·²ç»ä½¿ç”¨IDå¯¹é©±åŠ¨è¡¨è¿›è¡Œäº†è¿‡æ»¤ï¼ŒåŒæ—¶created_atçš„åˆ›å»ºæ—¶é—´å’Œidé¡ºåºéƒ½æ˜¯å¢žåºçš„ï¼Œæ‰€ä»¥å®Œå…¨å¯ä»¥ä½¿ç”¨idä»£æ›¿æˆ‘ä»¬çš„created_atã€‚   
é¢å¤–è¯´æ˜Ž: children_table å’Œ father_table å…³è”çš„æ•°æ®æ˜¯åŒæ—¶åˆ›å»ºçš„ï¼Œåªä¸è¿‡äºŒè€…æ˜¯çˆ¶å­å…³ç³»ï¼Œæ‰€ä»¥å®Œå…¨å¯ä»¥ç”¨idå®žçŽ°order byå€’å™æŽ’åºã€‚
ä¸‹é¢æ˜¯æˆ‘ä»¬çš„SQL

```sql

SELECT `father_table`.`filed_1`,
       `father_table`.`order_code`,
       `father_table`.`filed_2`,
       `father_table`.`filed_3`,
       `father_table`.`filed_4`,
       `father_table`.`filed_5`,
       `father_table`.`filed_6`,
       `father_table`.`order_time`,
       `father_table`.`commodity_type`,
       `father_table`.`filed_7`,
       `father_table`.`filed_8`,
       `father_table`.`filed_10`,
       `father_table`.`filed_11`,
       `children_table`.`filed_12`,
       `children_table`.`filed_13`,
       `children_table`.`filed_14`,
       `children_table`.`filed_15`,
       `children_table`.`filed_16`,
       `children_table`.`filed_17`,
       `children_table`.`filed_18`,
       `children_table`.`filed_19`,
       `children_table`.`filed_20`,
       `children_table`.`id` AS `children_table_id`
FROM `children_table`
         USE INDEX (`PRIMARY`)
         INNER JOIN `father_table` ON `father_table`.`order_code` = `children_table`.`order_code`
WHERE `father_table`.`commodity_type` = '1'
  AND `father_table`.`filed_21` = '1'
  AND `father_table`.`order_time` >= '2023-06-01'
  AND `father_table`.`id` >= 456079
  AND `father_table`.`id` <= 654277
  AND `children_table`.`deleted_at` IS NULL
ORDER BY `father_table`.`id` DESC
LIMIT 100 OFFSET 111200;
```

| id | select_type | table          | partitions | type  | possible_keys  | key            | key_len | ref                        | rows   | filtered | Extra       |
|----|-------------|----------------|------------|-------|----------------|----------------|---------|----------------------------|--------|----------|-------------|
| 1  | SIMPLE      | father_table   | null       | range | PRIMARY        | PRIMARY        | 8       | null                       | 253191 | 0.33     | Using where |
| 1  | SIMPLE      | children_table | null       | ref   | idx_order_code | idx_order_code | 202     | mall.new_orders.order_code | 1      | 10       | Using where |

**æ‰§è¡Œæ—¶é—´ä»Ž1.6s ä¸‹é™åˆ° 1.2sï¼ŒåŒæ—¶using filesort æ¶ˆå¤±ï¼ŒæŽ’åºä¸å†éœ€è¦å¤–éƒ¨ç´¢å¼•æŽ’åº**

### ç¬¬ä¸‰æ­¥ ä¼˜åŒ–æ·±åº¦åˆ†é¡µ

åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„idåŒºé—´ï¼Œä½†æ˜¯æˆ‘ä»¬ä¾ç„¶æ²¡æœ‰è§„é¿æ·±åº¦åˆ†é¡µã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦åŠ å…¥ä»Žä¸šåŠ¡çš„è§’åº¦ã€‚   
è¿™ä¸ªæ…¢SQLæ‰§è¡Œä¸šåŠ¡æ˜¯æ–‡ä»¶çš„åŒæ­¥å¯¼å‡ºã€‚åŽç«¯é€šè¿‡åˆ†é¡µæŸ¥è¡¨ï¼Œå‘å‰ç«¯è¿”å›žåˆ†é¡µæ•°æ®ï¼Œæœ€åŽå‰ç«¯å°†åŽç«¯è¿”å›žçš„æ‰€æœ‰æ•°æ®æ‹¼æˆä¸€ä¸ªå¤§æ–‡ä»¶ã€‚è¿™ä¸ªå°±æ˜¯åŒæ­¥å¯¼å‡ºçš„æ ¸å¿ƒé€»è¾‘ã€‚   
çŽ°åœ¨çš„æƒ…å†µæ˜¯å‰ç«¯å‘Šè¯‰æˆ‘ä»¬çŽ°åœ¨è¦è¿”å›žç¬¬å‡ é¡µçš„æ•°æ®ï¼Œç„¶åŽæˆ‘ä»¬è¿›è¡Œåˆ†é¡µçš„è®¡ç®—ï¼Œä½†æ˜¯å‰ç«¯å…¶å®žå®Œå…¨å¯ä»¥ä¸å‘åŽç«¯ä¼ é¡µæ•°è€Œæ˜¯ç›´æŽ¥ä¼ idçš„åŒºé—´ï¼Œåªè¦åŽç«¯åœ¨ç¬¬ä¸€æ¬¡åˆ†é¡µè¿”å›žæ•°æ®çš„æ—¶å€™å‘ŠçŸ¥å‰ç«¯ç¬¦åˆæ£€ç´¢æ¡ä»¶çš„IDèŒƒå›´ï¼Œç„¶åŽå‰ç«¯æ‰¹é‡è‡ªå¢žå°±å¥½äº†ã€‚   
å¯èƒ½å…‰è¯´ä½ ä¸å¤ªæ˜Žç™½ï¼Œé‚£æˆ‘ä»¬ç®€å•æ¥çœ‹çœ‹ã€‚

1. åŽç«¯ç¬¬ä¸€æ¬¡åˆ†é¡µæŸ¥è¯¢çš„æ—¶å€™è¿”å›žä¸€ä¸ªåŒºé—´ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ðŸ‘†æˆ‘ä»¬ç¬¬ä¸€ä¸ªæŸ¥åˆ°çš„`456079` å’Œ `654277` ã€‚
2. ç„¶åŽå‰ç«¯å‘ŠçŸ¥åŽç«¯æ‰¹é‡æŸ¥è¯¢çš„æ•°æ®èŒƒå›´å’Œæ‰¹é‡å¤§å°ï¼Œè¿™æ ·åŽç«¯å°±å¯ä»¥ä¸ç”¨ä½¿ç”¨limitäº†ï¼Œç›´æŽ¥æ ¹æ®idè¿›è¡Œåˆ†ç‰‡äº†ã€‚
3. ä½†æ˜¯è¿™æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åŽç«¯æ²¡æœ‰åŠžæ³•åšorder byäº†ï¼Œåªèƒ½æœ‰å‰ç«¯ç»Ÿä¸€æŽ¥å—åˆ°å…¨é‡æ•°æ®ä¹‹åŽå†æœ€ç»ˆè¿›è¡Œorder byæ“ä½œï¼ˆå‰ç«¯çš„order by
   éœ€è¦æ—¶é—´ï¼Œä½†æ˜¯ä¸æ¶ˆè€—å†…å­˜ï¼Œå› ä¸ºæ•°æ®æ— è®ºæ˜¯å¦æŽ’åºéƒ½éœ€è¦æŽ¥å—å…¨é‡çš„æ•°æ®ï¼‰ã€‚
4. å½¢è±¡çš„æ¯”å–»ä¸€ä¸‹ï¼Œè¿™ä¸ªå…¶å®žå°±æ˜¯ä¸€ä¸ªæ»‘åŠ¨çª—å£ï¼Œçª—å£çš„å¤§å°å¯ä»¥åˆåŽç«¯å®šæ­»ï¼Œä½†æ˜¯çª—å£çš„ç§»åŠ¨å¿…é¡»æœ‰å‰ç«¯æŽ§åˆ¶ï¼Œå¹¶ä¸”æœ€ç»ˆç”±å‰ç«¯è¿›è¡ŒæŽ’åºã€‚
5. æˆ‘ä»¬çš„SQLå°±ä¼šå˜æˆä¸‹é¢è¿™æ ·ðŸ‘‡

```sql
SELECT `father_table`.`filed_1`,
       `father_table`.`order_code`,
       `father_table`.`filed_2`,
       `father_table`.`filed_3`,
       `father_table`.`filed_4`,
       `father_table`.`filed_5`,
       `father_table`.`filed_6`,
       `father_table`.`order_time`,
       `father_table`.`commodity_type`,
       `father_table`.`filed_7`,
       `father_table`.`filed_8`,
       `father_table`.`filed_10`,
       `father_table`.`filed_11`,
       `children_table`.`filed_12`,
       `children_table`.`filed_13`,
       `children_table`.`filed_14`,
       `children_table`.`filed_15`,
       `children_table`.`filed_16`,
       `children_table`.`filed_17`,
       `children_table`.`filed_18`,
       `children_table`.`filed_19`,
       `children_table`.`filed_20`,
       `children_table`.`id` AS `children_table_id`
FROM `children_table`
         INNER JOIN `father_table` ON `father_table`.`order_code` = `children_table`.`order_code`
WHERE `father_table`.`commodity_type` = '1'
  AND `father_table`.`filed_21` = '1'
  AND `father_table`.`order_time` >= '2023-06-01'
  AND `father_table`.`id` >= 456079
  AND `father_table`.`id` <= 457079 # é™å®šèŒƒå›´ åªæŸ¥è¯¢1000æ¡ ç„¶åŽç­‰å¾…ä¸‹ä¸€æ¬¡çª—å£çš„å¢žé•¿ !!!!! 
  AND `children_table`.`deleted_at` IS NULL
```

åœ¨è¿™ä¸ªSQLä¸­ï¼Œæˆ‘ä»¬ä¼šæå–å‡º`father_table`.`id` åœ¨ [456079,457079]
è¿™ä¸ªèŒƒå›´åŒºé—´å†…çš„æ•°æ®ã€‚ç„¶åŽåˆ¤æ–­æ˜¯å¦ç¬¦åˆæ¡ä»¶ï¼Œæ‰€ä»¥æœ€åŽè¿”å›žçš„æ•°æ®ä¸€å®š<=1000  
æ³¨æ„âš ï¸ï¼šè¿™ä¸€æ­¥ ç”±äºŽé™å®šäº†idåŒºé—´ USE INDEX å’Œ ORDER BY å’Œ LIMITå¯ä»¥å…¨éƒ¨ä¸å†™äº†âœï¸ï¼Œæ‰€ä»¥æ•ˆçŽ‡éžå¸¸éžå¸¸çš„é«˜ï¼Œ**æ‰§è¡Œæ—¶é—´ç›´æŽ¥ä»Ž1.2sé™è‡³200ms**ã€‚
ç”±æ­¤å¯è§æ·±åº¦åˆ†é¡µï¼Œorder byï¼Œå¤–éƒ¨ç´¢å¼•å¯¹æˆ‘ä»¬çš„å½±å“æ˜¯å·¨å¤§çš„ã€‚

| id | select_type | table          | partitions | type        | possible_keys                                                        | key                                     | key_len | ref                        | rows | filtered | Extra                                                                 |
|----|-------------|----------------|------------|-------------|----------------------------------------------------------------------|-----------------------------------------|---------|----------------------------|------|----------|-----------------------------------------------------------------------|
| 1  | SIMPLE      | father_table   | null       | index_merge | PRIMARY, uniq_o, index_business_id, order_code, index_commodity_type | index_commodity_type, index_business_id | 13,12   | null                       | 1    | 33.33    | Using intersect(index_commodity_type, index_business_id); Using where |
| 1  | SIMPLE      | children_table | null       | ref         | idx_order_code                                                       | idx_order_code                          | 202     | mall.new_orders.order_code | 1    | 10       | Using where                                                           |

--- 


## 10ã€ä¸€ä¸ªæ…¢æŽ¥å£
æŽ¥ä¸‹é‡Œç»™å¤§å®¶åˆ†äº«ä¸€ä¸ªæ…¢æŽ¥å£è¿™ä¸ªæŽ¥å£å°±æ˜¯çº¯ä»£ç é—®é¢˜äº†ï¼Œä½†æ˜¯æƒ³ç»™å¤§å®¶åˆ†äº«ä¸€ç§å­æŸ¥è¯¢çš„å®žçŽ°æ–¹æ³• ã€‚   
çŽ°åœ¨å…ˆäº¤ä»£ä¸€ä¸‹èƒŒæ™¯ï¼š  
1. è¿™æ˜¯ä¸€ä¸ªåˆ—è¡¨é¡µå±•ç¤ºï¼Œæ¯ä¸€é¡µðŸ“„å…±10è¡Œæ•°æ®ã€‚
2. ç„¶åŽæ¯ä¸€è¡Œæ•°æ®éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€æ¶ˆè´¹åˆ¸id
3. ç„¶åŽæ¯ä¸€è¡Œæ•°æ®éƒ½éœ€è¦æŸ¥è¯¢5ä¸ªçŠ¶æ€æ•°æ®æ€»é‡ï¼ŒåŒ…æ‹¬`å·²ä½¿ç”¨` ã€ `å¾…ä½¿ç”¨` ã€ `å·²è¿‡æœŸ` ã€ `å·²ä½œåºŸ` ã€ `æœªå¼€å§‹`
   1. `å·²ä½¿ç”¨` æ˜¯è¿™ä¸ªcouponçš„ status ä¸º 2
   2. `å¾…ä½¿ç”¨` æ˜¯è¿™ä¸ªcouponçš„ status ä¸º1 ç„¶åŽèµ·å§‹æ—¶é—´start_time å°äºŽç­‰äºŽä»Šå¤© && ç»ˆæ­¢æ—¶é—´end_time å¤§äºŽç­‰äºŽä»Šå¤©
   3. `å·²è¿‡æœŸ` æ˜¯è¿™ä¸ªcouponçš„ status ä¸º1 ç„¶åŽend_time å°äºŽä»Šå¤©
   4. `æœªå¼€å§‹` æ˜¯è¿™ä¸ªcouponçš„ status ä¸º1 ä½†æ˜¯start_time å¤§äºŽä»Šå¤© 
   5. `å·²ä½œåºŸ` æ˜¯è¿™ä¸ªcouponçš„ status ä¸º3 

çœ‹åˆ°è¿™é‡Œï¼Œä½ çš„æ€è·¯æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•å†åˆ†é¡µæŸ¥è¯¢çš„åŸºç¡€ä¸ŠæŸ¥å‡ºæ¯ä¸€è¡Œæ•°æ®çš„5ä¸ªå­—æ®µï¼Ÿ

æ€è·¯æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯10æ¬¡SQLæŸ¥è¯¢ã€5æ¬¡SQLæŸ¥è¯¢ å’Œ ä¸€æ¬¡SQLæŸ¥è¯¢ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥çœ‹

### 10æ¬¡SQLæŸ¥è¯¢
è¿™ä¸ªæ€è·¯å…¶å®žå¾ˆæ¸…æ™°ï¼Œåªè¦æˆ‘ä»¬å¯¹åˆ†é¡µç»“æžœçš„IDè¿›è¡ŒéåŽ†ï¼Œä¹Ÿå°±æ˜¯å¯¹ä¸€é¡µçš„10è¡Œæ•°æ®éåŽ†ï¼Œç„¶åŽæ¯ä¸€è¡Œéƒ½åŽ»æŸ¥5ä¸ªçŠ¶æ€å°±å¥½äº†ã€‚   
ç„¶åŽæˆ‘ä»¬å°†5ä¸ªçŠ¶æ€å˜é‡çš„èŽ·å–å†™åœ¨ä¸€ä¸ªSQLé‡Œé¢ è¿™æ ·ä¸€é¡µæ•°æ®æˆ‘ä»¬å°±åªéœ€è¦10æ¬¡æŸ¥è¯¢å°±å¯ä»¥è§£å†³äº†ã€‚   
SQLåœ¨ä¸‹é¢ðŸ‘‡ï¼Œæ˜¯å¤šä¸ªå­æŸ¥è¯¢ã€‚
```sql
SELECT
    (SELECT count(*)
     FROM coupon
     WHERE coupon_id = 207
       AND status = 1
       AND start_time > '2024-10-30') AS unstart,
    (SELECT count(*)
     FROM coupon
     WHERE coupon_id = 207
       AND status = 2) AS used,
    (SELECT count(*)
     FROM coupon
     WHERE coupon_id = 207
       AND status = 1
       AND start_time <= '2024-10-28'
       AND end_time >= '2024-10-30') AS wait_used,
    (SELECT count(*)
     FROM coupon
     WHERE coupon_id = 207
       AND status = 1
       AND end_time < '2024-10-30') AS expire,
    (SELECT count(*)
     FROM coupon
     WHERE coupon_id = 207
       AND status = 3) AS deleted
```


### 5æ¬¡SQLæŸ¥è¯¢
è¿™ä¸ªæŸ¥è¯¢å°±å˜æ¢äº†ä¸€ä¸‹çº¬åº¦ï¼Œæˆ‘ä»¬ä¸å†ä¸€è¡Œä¸€è¡Œçš„æŸ¥ï¼Œè€Œæ˜¯æ ¹æ®ä¸åŒçš„çŠ¶æ€åˆ†åˆ«æŸ¥è¯¢å‡º10ä¸ªcoupon çš„çŠ¶æ€ä¿¡æ¯ã€‚   
è¿™ä¸ªå†™æ³•çš„æ€è·¯å°±æ˜¯ä½¿ç”¨INæŸ¥è¯¢ï¼Œæˆ‘ä»¬ä¼˜å…ˆéåŽ†å‡ºä¸€é¡µ10è¡Œæ•°æ®çš„å”¯ä¸€idï¼Œç„¶åŽæ ¹æ®çŠ¶æ€å°†è¿™10ä¸ªIDåªç”¨INè¿›è¡ŒåŒ¹é…ï¼Œç„¶åŽä½¿ç”¨group byè¿›è¡Œåˆ†ç»„ï¼Œæœ€åŽå°±å¾—åˆ°è¿™10è¡Œæ•°æ®çš„å„è‡ªçš„ä¸€ä¸ªçŠ¶æ€ã€‚   
SQLåœ¨ä¸‹é¢ðŸ‘‡   
```sql
# æŸ¥è¯¢ å¾…ä½¿ç”¨ çŠ¶æ€çš„æ•°æ®
select count(*) as wait_used
from coupon
where coupon_id in (198, 199, 200, 201, 202, 203, 204, 205, 206, 207)
  and status = 1
  AND start_time <= '2024-10-29'
  AND end_time >= '2024-10-29'
group by coupon_id
```

### 1æ¬¡æŸ¥è¯¢
1æ¬¡æŸ¥è¯¢èµ·å§‹å°±æ˜¯åœ¨10æ¬¡æŸ¥è¯¢çš„åŸºç¡€ä¸Šä½¿ç”¨UNION ALL ï¼Œå°†10è¡Œæ•°æ®çš„SQLæ‹¼æŽ¥æˆä¸€ä¸ªå¤§SQLï¼Œä»Žè€Œå‡å°‘ç½‘ç»œçš„IOæ¬¡æ•°ï¼Œå¹¶ä¼˜åŒ–æ…¢æŽ¥å£çš„å“åº”æ—¶é—´ã€‚
ä½†æ˜¯éšä¹‹è€Œæ¥çš„SQLè¯­å¥è¿‡é•¿ï¼Œä¸€æ¡SQLçš„æ‰§è¡Œæ—¶é—´ä¼šå˜çš„å¾ˆé•¿ï¼ˆå½“ç„¶å¯èƒ½ä¸€ä¸ªSQLçš„æ‰§è¡Œæ—¶é—´å°äºŽ10æ¬¡ç½‘ç»œIOçš„æ—¶é—´ï¼‰ã€‚å…·ä½“æ˜¯å¦é‡‡ç”¨éœ€è¦æ ¹æ®æƒ…å†µæ¥å®šï¼Œä½†æ˜¯ä¸€èˆ¬ä¸æŽ¨èï¼Œå› ä¸ºæŽ¥å£çš„æ‰©å±•æ€§å¤ªå·®ã€‚  
SQLè¿˜æ˜¯åœ¨ä¸‹é¢ðŸ‘‡ 
```sql
SELECT (SELECT count(*)
        FROM coupon
        WHERE coupon_id = 207
          AND status = 1
          AND start_time > '2024-10-30') AS unstart,
       (SELECT count(*)
        FROM coupon
        WHERE coupon_id = 207
          AND status = 2)                AS used,
       (SELECT count(*)
        FROM coupon
        WHERE coupon_id = 207
          AND status = 1
          AND start_time <= '2024-10-28'
          AND end_time >= '2024-10-30')  AS wait_used,
       (SELECT count(*)
        FROM coupon
        WHERE coupon_id = 207
          AND status = 1
          AND end_time < '2024-10-30')   AS expire,
       (SELECT count(*)
        FROM coupon
        WHERE coupon_id = 207
          AND status = 3)                AS deleted

UNION ALL

SELECT (SELECT count(*)
        FROM coupon
        WHERE coupon_id = 207
          AND status = 1
          AND start_time > '2024-10-30') AS unstart,
       (SELECT count(*)
        FROM coupon
        WHERE coupon_id = 207
          AND status = 2)                AS used,
       (SELECT count(*)
        FROM coupon
        WHERE coupon_id = 207
          AND status = 1
          AND start_time <= '2024-10-28'
          AND end_time >= '2024-10-30')  AS wait_used,
       (SELECT count(*)
        FROM coupon
        WHERE coupon_id = 207
          AND status = 1
          AND end_time < '2024-10-30')   AS expire,
       (SELECT count(*)
        FROM coupon
        WHERE coupon_id = 207
          AND status = 3)                AS deleted
```
### è¯„åˆ¤ä¸€ä¸‹è¿™ä¸‰ç§å†™æ³•âœï¸
å°±çŽ°åœ¨ä¸‰ç§å†™æ³•æ¥è¯´ï¼Œ**5æ¬¡æŸ¥è¯¢ä½¿ç”¨INçš„å†™æ³•æœ€å¥½**ã€‚å› ä¸ºä¸€é¡µæ•°æ®éœ€è¦è¿›è¡Œçš„çš„æ•°æ®åº“æŸ¥è¯¢æ“ä½œæœ€å°‘ï¼ŒåŒæ—¶æ‰©å±•æ€§æœ€é«˜ã€‚å¦‚æžœæˆ‘ä¸€é¡µçš„å±•ç¤ºçš„æ•°é‡å˜å¤šäº†ï¼Œé‚£ä¹ˆåªè¦åœ¨INçš„è¯­å¥ä¸­åŠ ä¸€ä¸ªidå°±å¥½äº†ï¼Œ
æˆ–è€…å¤šä¸€ä¸ªæŸ¥è¯¢çŠ¶æ€å°±å¤šå†™ä¸€ç§æƒ…å†µå¤šä¸€å¥SQLå°±æžå®šðŸ¤ã€‚   
å½“ç„¶è¿™ä¸ªæ…¢æŽ¥å£çš„é—®é¢˜è§£å†³çš„æ–¹æ¡ˆå¾ˆå¤šï¼Œä¹Ÿä¸å¤æ‚ï¼Œä½†æ›´å¤šæ˜¯ä½œä¸ºä¸€æ¬¡å¯å‘ï¼Œå‘Šè¯‰æˆ‘ä»¬å†™SQLçš„æ—¶å€™ä¸ä¸€å®šè¦è¿½ç€IDä¸æ”¾ï¼Œå¯ä»¥ä»Žå…¶ä»–è§’åº¦è¿›è¡Œåˆ‡å…¥ï¼Œä¾‹å¦‚ä¸Šé¢çš„â€œæ ¹æ®5ä¸ªçŠ¶æ€åˆ†åˆ«æŸ¥è¯¢æ‰€æœ‰IDçš„æ•°æ®â€ã€‚    
è™½ç„¶SQLéƒ½æ˜¯ç»“æž„åŒ–çš„ï¼Œä½†æ˜¯æ€ç»´ä¸è¦åƒµç¡¬äº†ã€‚


## æ€»ç»“
ç›¸ä¿¡å¤§å®¶çœ‹åˆ°è¿™é‡Œï¼Œå°±å·²ç»å¯¹æ…¢SQLçš„æŽ’æŸ¥æ€è·¯ï¼Œå’Œä¼˜åŒ–æ€è·¯æœ‰äº†ä¸€å®šçš„äº†è§£å’ŒæŽŒæ¡ã€‚æ‰€ä»¥æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬åˆ°åº•éœ€è¦åšå“ªäº›æ­¥éª¤ã€‚   
1. çº¿ä¸Šæµ‹è¯•ï¼ŒéªŒè¯ä¸€ä¸‹æ…¢SQLæ˜¯å¶ç„¶è¿˜æ˜¯é¢‘å‘ã€‚
2. åˆ‡è®°ä¸€ä¸Šæ¥å°±å¼€å§‹SQLåˆ†æžï¼Œä¸€å®šè¦ä¼˜å…ˆç¡®è®¤ä¸šåŠ¡åœºæ™¯ï¼Œæ˜¯å“ªä¸ªæŽ¥å£æ…¢äº†ï¼Œè¿˜æ˜¯å®šæ—¶ä»»åŠ¡é‡Œé¢çš„è„šæœ¬æ…¢äº†ï¼Œè¿˜æ˜¯å¼‚æ­¥æ¶ˆè´¹é‡Œé¢æ…¢äº†ã€‚
   1. å½“ç„¶å¦‚æžœæœ‰äººå‘Šè¯‰ä½ ä¼˜åŒ–è¿™ä¸ªSQLå°±å¯ä»¥äº†ï¼Œé‚£ä¹ˆç›´æŽ¥åˆ†æžæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯ä¸€èˆ¬æ˜¯ä¸€ä¸ªæ…¢æŽ¥å£ï¼Œç„¶åŽå‘çŽ°æ˜¯SQLå¾ˆæ…¢ã€‚
3. ä¸šåŠ¡ç¡®è®¤å®Œäº†ä¹‹åŽï¼Œä½ å°±çŸ¥é“è¿™ä¸ªSQLä»€ä¹ˆæ„æ€äº†ï¼Œç„¶åŽå°±å¼€å§‹åˆ†æžSQLäº†ã€‚
4. ä¼˜å…ˆEXPLAINè¿›è¡Œåˆ†æž
   1. ä¼˜å…ˆè€ƒè™‘åŠ ç´¢å¼•ï¼Œå› ä¸ºå¯ä»¥ä¸ç”¨æ”¹ä»£ç 
   2. å†ç„¶åŽæƒ³æ›´æ¢ç´¢å¼•æˆ–è€…æŸäº›å­—æ®µä»¥å®žçŽ°åŒæ ·çš„æ•ˆæžœã€‚ï¼ˆæ›´æ¢çš„ç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨ç´¢å¼•ï¼‰
5. æœ€åŽè€ƒè™‘æ”¹ä»£ç 
   1. å¦‚æžœæ˜¯å¤§çš„è”è¡¨å°±å°†è”è¡¨çš„éƒ¨åˆ†æ‹†æˆå¤šä¸ªç‹¬ç«‹è¡¨çš„æŸ¥è¯¢
   2. ç„¶åŽè€ƒè™‘åˆ é™¤ä¸€äº›æ— ç”¨çš„æŸ¥è¯¢æ­¥éª¤ï¼ˆå¯èƒ½æ˜¯è¡¨è”å¤šäº†ï¼Œä¹Ÿå¯èƒ½è¿”å›žçš„æ•°æ®å¤šäº†ï¼‰
6. æœ€åŽçš„æœ€åŽï¼Œå¦‚æžœä¸Šé¢çš„æ•ˆæžœéƒ½ä¸å¥½ï¼Œé‚£ä¹ˆå°±è¦è€ƒè™‘å¤§æ”¹æŽ¥å£äº†ï¼Œè¿™ä¸ªå°±ä¼šæ¶‰åŠåˆ°é£Žé™©æ“ä½œï¼Œéœ€è¦æœ‰æž¶æž„å¸ˆæˆ–è€…éƒ¨é—¨é¢†å¯¼åå•†ã€‚

æœ€åŽæ”¹å®Œäº†ï¼Œå…ˆåˆ°æµ‹è¯•æµ‹ä¸€æµ‹ï¼Œç„¶åŽå†çœ‹çœ‹åŽ»çº¿ä¸Šå›žå½’ï¼Œæœ€åŽéªŒè¯ã€‚   
å¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ—¶é—´ä¸æ—©äº†ï¼Œå¤§å®¶æ—©ç‚¹ä¼‘æ¯ï¼Œå‡†å¤‡ç¡è§‰ðŸ˜´ðŸ›ŒðŸ˜´ðŸ›Œã€‚
